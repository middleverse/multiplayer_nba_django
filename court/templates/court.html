{% extends 'court_base.html' %}

{% block court_content %}

This is court#{{court_id}}. This contains a lobby and a game.

<h3>{{ role }}</h3>

{{ court_id|json_script:"court-id" }}

{% include "create_court.html" %}

{% include "lobby.html" %}

{% include "game.html" %}

<script>
    // ================================
    // KEEP AS MUCH JS HERE AS POSSIBLE
    // ================================

    /*
    GLOBALS
    -------
    */

    var division = ''
    var shot_clock = 17
    var player_name = ''
    var player_icon = ''
    var session_questions = []

    /* 
    WEBSOCKET CONNECT
    -----------------
    Start a connection
    On message recieve functionality
    */

    const court_id = JSON.parse(document.getElementById('court-id').textContent)
    const court_socket = new WebSocket(
        'ws://' 
        + window.location.host
        + '/ws/court/'
        + court_id
        + '/'
    );

    court_socket.onerror = function(e) {
        console.log(e)
    }

    court_socket.onmessage = function(e) {
        const data = JSON.parse(e.data)
        // CREATED COURT (SUCCESS)
        if (data['message'] === 'court_message') {
            console.log(data['text'])
            // var question_object = JSON.parse(data['text'])
            // console.log(question_object)
        }
        // CREATED GAME (SUCCESS)
        else if (data['message'] === 'create_game_message') {
            console.log('GAME CREATED, Transision To LObby NExt.')
            //console.log(data['text'])
            question_set_data = data['text']['question_set']
            question_set_parsed_data = JSON.parse(question_set_data)
            //console.log(question_set_parsed_data)
            session_questions = question_set_parsed_data
            console.log(session_questions)
            // SHOW LOBBY
            // HIDE EVERYTHING ELSE
        }
        else if (data['message'] === 'start_game_message') {

        }

    }

    /*
    CREATE GAME
    ----------------
    Also loads questions from db
    Eventually (user a websocket to get the next 10 questions)
    Current (get 1 question)
    */

    document.getElementById('game-config-form').addEventListener('submit', function(event) {
        event.preventDefault();
        const form = event.target
        const form_data = new FormData(form)
        const division = form_data.getAll('division')
        const shot_clock = form_data.get('shot_clock')
        const url = form.getAttribute('action')
        const method = form.getAttribute('method') 
        const xhr = new XMLHttpRequest()
        const responseType = 'json'
        xhr.open(method, url) // make the request 
        xhr.setRequestHeader('HTTP_X_REQUESTED_WITH', 'XMLHttpRequest') // convetion to call setRequestHeader is after open and before send
        xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest')
        
        xhr.onload = function() {
            if (xhr.status === 201) {
                const r = xhr.response
                r_json = JSON.parse(r)
                console.log('given divs:')
                console.log(division)

                court_socket.send(JSON.stringify({
                    'message_type': 'create_game',
                    'shot_clock': shot_clock,
                    'division': division
                }));
            }     
            else {
                const r = xhr.response
                console.log(r)
            }
        }

        xhr.onerror = function() {
                alert("An error has occurred.")
        }
        
        xhr.send(form_data)
        
        
    });    


    /* 
    SHOW LOBBY 
    ----------
    Show each player's icon, and config options
    */

    /* 
    START GAME
    ----------
    Toggle lobby template
    Toggle game template
    (Auto-toggle takes care of correct visbility)
    */

    var lobby_container_el = document.getElementById('lobby-container')
    var game_container_el = document.getElementById('game-container')

    document.getElementById('start-game').addEventListener('click', function(event) {
        event.preventDefault();
        console.log(game_container_el);
        game_container_el.classList.toggle('invisible');
        lobby_container_el.classList.toggle('invisible');
    });

    /* 
    END GAME
    --------
    Hide game template
    Show lobby template
    */

    document.getElementById('end-game').addEventListener('click', function(event) {
        event.preventDefault();
        console.log(lobby_container_el);
        lobby_container_el.classList.toggle('invisible');
        game_container_el.classList.toggle('invisible');
    });




</script>

{% endblock %}
